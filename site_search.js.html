<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Frontend Documentation</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: site/search.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// Generated by CoffeeScript 1.12.7

/**
 * Search functionality
 * @mixin site/search
 */
'use strict';
app.controller('site/search', [
  '$scope', '$location', 'constantService', 'displayService', 'modelService', 'searchService', 'parties', 'volumes', function($scope, $location, constants, display, models, Search, parties, volumes) {
    var Default, Number, Quoted, Range, ageLogOffset, ageSliderValue, any, f, fields, finite, handlers, mi, n, offset, params, process, rangeRegex, ref, spellcheck, startTag, type, v;
    display.title = 'Search';
    spellcheck = {};
    process = function(r) {
      var i, j, list, ref, sug;
      list = r.response.docs;
      list.count = r.response.numFound;
      if ((sug = r.spellcheck) &amp;&amp; (sug = sug.suggestions)) {
        for (i = j = 1, ref = sug.length; j &lt;= ref; i = j += 2) {
          spellcheck[sug[i - 1]] = sug[i].suggestion;
          $scope.spellcheck = spellcheck;
        }
      }
      return list;
    };
    if (parties) {
      $scope.parties = process(parties);
      if (!volumes) {
        type = Search.Party;
        $scope.count = $scope.parties.count;
      }
    }
    if (volumes) {
      $scope.volumes = process(volumes);
      if (!parties) {
        type = Search.Volume;
        $scope.count = $scope.volumes.count;
      }
    }
    params = $location.search();
    $scope.query = params.q || '';
    if (type) {
      offset = parseInt(params.offset, 10) || 0;
      $scope.pageCurrent = 1 + (offset / type.limit);
      $scope.pageCount = Math.ceil($scope.count / type.limit);
    }
    finite = function(x) {
      return (x != null) &amp;&amp; isFinite(x);
    };
    Default = {
      parse: function(x) {
        return x;
      },
      print: function(x) {
        if (x) {
          return x;
        }
      }
    };
    Number = {
      parse: function(x) {
        if (x !== '*') {
          return parseFloat(x);
        }
      },
      print: function(x) {
        if (finite(x)) {
          return x;
        } else {
          return '*';
        }
      }
    };
    rangeRegex = /^\[([-+0-9.e]+|\*) TO ([-+0-9.e]+|\*)\]$/i;
    Range = {
      set: function(x) {
        return x &amp;&amp; (finite(x[0]) || finite(x[1]));
      },
      parse: function(x) {
        var ref, ref1;
        x = rangeRegex.exec(x) || [];
        return [(ref = Number.parse(x[1])) != null ? ref : -2e308, (ref1 = Number.parse(x[2])) != null ? ref1 : 2e308];
      },
      print: function(x) {
        if (x) {
          if (!(x[0] > this.range[0])) {
            x[0] = -2e308;
          }
          if (!(x[1] &lt; this.range[1])) {
            x[1] = 2e308;
          }
        }
        if (Range.set(x)) {
          return '[' + Number.print(x[0]) + ' TO ' + Number.print(x[1]) + ']';
        }
      }
    };
    Quoted = {
      parse: function(x) {
        return x.substring(x.startsWith('"'), x.length - x.endsWith('"'));
      },
      print: function(x) {
        if (x) {
          return '"' + x + '"';
        }
      }
    };
    $scope.years = [1925, (new Date()).getFullYear()];
    handlers = {
      record_age: {
        parse: Range.parse,
        print: Range.print,
        range: [0, constants.age.limit]
      },
      container_date: {
        parse: function(x) {
          x = Range.parse(x);
          if (Range.set(x)) {
            fields.container_top = 'false';
          }
          return x;
        },
        print: function(x) {
          if (fields.container_top) {
            return Range.print.call(this, x);
          }
        },
        range: $scope.years
      },
      numeric: Range,
      tag_name: Quoted
    };
    $scope.fields = fields = {};
    for (f in handlers) {
      v = handlers[f];
      if (v.range) {
        fields[f] = [v.range[0], v.range[1]];
      }
    }
    for (f in params) {
      v = params[f];
      if (f.startsWith('f.')) {
        n = f.substr(2);
        fields[n] = ((ref = handlers[n]) != null ? ref : Default).parse(v);
      } else if (f.startsWith('m.')) {
        mi = f.substr(2);
      }
    }
    any = function(o) {
      for (f in o) {
        v = o[f];
        if (v != null) {
          return true;
        }
      }
      return false;
    };
    $scope.search = function(offset) {
      var q, ref1;
      q = {
        q: $scope.query || void 0,
        offset: offset,
        volume: type != null ? type.volume : void 0
      };
      for (f in fields) {
        v = fields[f];
        q['f.' + f] = ((ref1 = handlers[f]) != null ? ref1 : Default).print(v);
      }
      if (q['f.container_date']) {
        delete q['f.container_top'];
      }
      $location.search(q);
    };
    $scope.searchParties = function(auth, inst) {
      fields = {};
      fields.party_authorization = auth;
      fields.party_is_institution = inst;
      type = Search.Party;
      return $scope.search(0);
    };
    $scope.searchVolumes = function() {
      type = Search.Volume;
      return $scope.search(0);
    };
    $scope.searchSpellcheck = function(w, s) {
      $scope.query = $scope.query.replace(w, s);
      return $scope.search();
    };
    $scope.searchPage = function(n) {
      return $scope.search(type.limit * (n - 1));
    };
    startTag = fields.tag_name;
    $scope.tagSearch = function(input) {
      if (input === startTag) {
        return input;
      }
      return models.Tag.search(input).then(function(data) {
        var j, len, results, tag;
        results = [];
        for (j = 0, len = data.length; j &lt; len; j++) {
          tag = data[j];
          results.push({
            text: tag,
            select: function() {
              fields.tag_name = this.text;
              $scope.searchVolumes();
              return this.text;
            }
          });
        }
        return results;
      });
    };
    $scope.formats = _.filter(constants.format, function(f) {
      return !f.transcodable || f.id &lt; 0;
    });
    ageSliderValue = [0, 0];
    ageLogOffset = 16;
    $scope.ageSlider = function(value) {
      var x, y;
      if (value != null) {
        fields.record_age[0] = Math.round(Math.exp(value[0]) - ageLogOffset);
        return fields.record_age[1] = Math.round(Math.exp(value[1]) - ageLogOffset);
      } else {
        x = Math.log(ageLogOffset + Math.max(0, fields.record_age[0]));
        y = Math.log(ageLogOffset + Math.min(constants.age.limit, fields.record_age[1]));
        if (x !== ageSliderValue[0] || y !== ageSliderValue[1]) {
          ageSliderValue = [x, y];
        }
        return ageSliderValue;
      }
    };
    $scope.ageRange = [Math.log(ageLogOffset), Math.log(ageLogOffset + constants.age.limit)];
    $scope.clearAge = function() {
      return fields.record_age = [-2e308, 2e308];
    };
    $scope.expandVolume = function(v) {
      var ref1;
      if (v &amp;&amp; ((ref1 = $scope.expanded) != null ? ref1.volume : void 0) === v) {
        $scope.expanded = void 0;
        return;
      }
      $scope.expanded = {
        volume: v
      };
      if (!v) {
        return;
      }
      v.get(['excerpts']);
    };
    if ($scope.fields.content_type === 'excerpt' &amp;&amp; !$scope.expanded) {
      $scope.expandVolume($scope.volumes[0]);
    }
  }
]);

//# sourceMappingURL=search.js.map
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Databrary Frontend AngularJS</a></h2><div><h3>Directives</h3><ul><li><a href="module-directive_clickElsewhere.html">directive/clickElsewhere</a></li><li><a href="module-directive_fileModel.html">directive/fileModel</a></li><li><a href="module-directive_focus.html">directive/focus</a></li><li><a href="module-directive_fold.html">directive/fold</a></li><li><a href="module-directive_form.html">directive/form</a></li><li><a href="module-directive_formCtrl.html">directive/formCtrl</a></li><li><a href="module-directive_hint.html">directive/hint</a></li><li><a href="module-directive_homeContainer.html">directive/homeContainer</a></li><li><a href="module-directive_inputDate.html">directive/inputDate</a></li><li><a href="module-directive_keypress.html">directive/keypress</a></li><li><a href="module-directive_message.html">directive/message</a></li><li><a href="module-directive_mousedrag.html">directive/mousedrag</a></li><li><a href="module-directive_scrollFloat.html">directive/scrollFloat</a></li><li><a href="module-directive_setContents.html">directive/setContents</a></li><li><a href="module-directive_tooltip.html">directive/tooltip</a></li><li><a href="module-directive_validator.html">directive/validator</a></li><li><a href="module-directive_video.html">directive/video</a></li><li><a href="module-party_authApply.html">party/authApply</a></li><li><a href="module-party_authGrant.html">party/authGrant</a></li><li><a href="module-party_authSearch.html">party/authSearch</a></li><li><a href="module-party_comments.html">party/comments</a></li><li><a href="module-party_data.html">party/data</a></li><li><a href="module-party_editAccount.html">party/editAccount</a></li><li><a href="module-party_editApply.html">party/editApply</a></li><li><a href="module-party_editGrant.html">party/editGrant</a></li><li><a href="module-party_editNotifications.html">party/editNotifications</a></li><li><a href="module-party_editProfile.html">party/editProfile</a></li><li><a href="module-party_load.html">party/load</a></li><li><a href="module-party_loginForm.html">party/loginForm</a></li><li><a href="module-party_network.html">party/network</a></li><li><a href="module-party_portrait.html">party/portrait</a></li><li><a href="module-party_userPasswordForm.html">party/userPasswordForm</a></li><li><a href="module-site_activity.html">site/activity</a></li><li><a href="module-site_activityChange.html">site/activityChange</a></li><li><a href="module-site_commentReply.html">site/commentReply</a></li><li><a href="module-site_displayAge.html">site/displayAge</a></li><li><a href="module-site_errors.html">site/errors</a></li><li><a href="module-site_figure.html">site/figure</a></li><li><a href="module-site_frame.html">site/frame</a></li><li><a href="module-site_inputAge.html">site/inputAge</a></li><li><a href="module-site_inputCompleter.html">site/inputCompleter</a></li><li><a href="module-site_notifications.html">site/notifications</a></li><li><a href="module-site_panel.html">site/panel</a></li><li><a href="module-site_searchForm.html">site/searchForm</a></li><li><a href="module-site_tagAdd.html">site/tagAdd</a></li><li><a href="module-site_tags.html">site/tags</a></li><li><a href="module-site_toolbar.html">site/toolbar</a></li><li><a href="module-site_tooltip.html">site/tooltip</a></li><li><a href="module-site_wizard.html">site/wizard</a></li><li><a href="module-site_wizardStep.html">site/wizardStep</a></li><li><a href="module-volume_accessGrant.html">volume/accessGrant</a></li><li><a href="module-volume_accessSearch.html">volume/accessSearch</a></li><li><a href="module-volume_assist.html">volume/assist</a></li><li><a href="module-volume_cite.html">volume/cite</a></li><li><a href="module-volume_comments.html">volume/comments</a></li><li><a href="module-volume_design.html">volume/design</a></li><li><a href="module-volume_editAccess.html">volume/editAccess</a></li><li><a href="module-volume_editFunding.html">volume/editFunding</a></li><li><a href="module-volume_editLinks.html">volume/editLinks</a></li><li><a href="module-volume_editOverview.html">volume/editOverview</a></li><li><a href="module-volume_excerpts.html">volume/excerpts</a></li><li><a href="module-volume_filter.html">volume/filter</a></li><li><a href="module-volume_fundingGrant.html">volume/fundingGrant</a></li><li><a href="module-volume_fundingSearch.html">volume/fundingSearch</a></li><li><a href="module-volume_list.html">volume/list</a></li><li><a href="module-volume_metadata.html">volume/metadata</a></li><li><a href="module-volume_meter.html">volume/meter</a></li><li><a href="module-volume_meterCanvas.html">volume/meterCanvas</a></li><li><a href="module-volume_overview.html">volume/overview</a></li><li><a href="module-volume_owners.html">volume/owners</a></li><li><a href="module-volume_pivot.html">volume/pivot</a></li><li><a href="module-volume_showInvestigators.html">volume/showInvestigators</a></li><li><a href="module-volume_slot.html">volume/slot</a></li><li><a href="module-volume_spreadsheet.html">volume/spreadsheet</a></li></ul></div><div><h3>Services</h3><ul><li><a href="analyticService.html">analyticService</a></li><li><a href="authService.html">authService</a></li><li><a href="constantService.html">constantService</a></li><li><a href="displayService.html">displayService</a></li><li><a href="messageService.html">messageService</a></li><li><a href="modelService.html">modelService</a></li><li><a href="Offset.html">Offset</a></li><li><a href="pageService.html">pageService</a></li><li><a href="play.html">play</a></li><li><a href="routerService.html">routerService</a></li><li><a href="searchService.html">searchService</a></li><li><a href="Segment.html">Segment</a></li><li><a href="storageService.html">storageService</a></li><li><a href="styleService.html">styleService</a></li><li><a href="tooltipService.html">tooltipService</a></li><li><a href="uploadService.html">uploadService</a></li></ul></div><div><h3>Controllers</h3><ul><li><a href="party_activity.html">party/activity</a></li><li><a href="party_edit.html">party/edit</a></li><li><a href="party_login.html">party/login</a></li><li><a href="party_profile.html">party/profile</a></li><li><a href="party_register.html">party/register</a></li><li><a href="party_reset.html">party/reset</a></li><li><a href="party_search.html">party/search</a></li><li><a href="party_view.html">party/view</a></li><li><a href="site_home.html">site/home</a></li><li><a href="site_search.html">site/search</a></li><li><a href="volume_activity.html">volume/activity</a></li><li><a href="volume_csv.html">volume/csv</a></li><li><a href="volume_edit.html">volume/edit</a></li><li><a href="volume_search.html">volume/search</a></li><li><a href="volume_slotActivity.html">volume/slotActivity</a></li><li><a href="volume_view.html">volume/view</a></li><li><a href="volume_zip.html">volume/zip</a></li></ul></div><div><h3>Functions</h3><ul><li><a href="-_anonymous_-pre-checkDirty.html">checkDirty</a></li><li><a href="-_anonymous_-pre-form.$setUnsubmitted.html">$setUnsubmitted</a></li><li><a href="-_anonymous_-pre-form.resetAll.html">resetAll</a></li></ul></div>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri May 18 2018 11:45:42 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
